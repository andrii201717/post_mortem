
160924_ptm  Andrii Tabaka  


Post mortem

Причины инцидента

На мой взгляд, основными причинами инцидента стали пустой конфигурационный файл и отсутствие свободного места на дисковом пространстве.
Предпринятые шаги для восстановления сервиса и устранения проблемы и полученные результаты
На нашем проекте мы столкнулись с неисправностью удалённого сервера. Для решения этой проблемы мы попытались подключиться к серверу с использованием ключа доступа. Первоначально это не удалось из-за отсутствия прав доступа. Мы получили доступ с помощью команды:


chmod 600 /home/igor/ich/ich.pem

После входа на сервер проверили статус демонов командой:
 
sudo systemctl status httpd

Обратившись к ошибке, отображённой на сервере, обнаружили, что проблема связана с файлом LocalSettings.php. Для поиска файла использовали команду: 

sudo find / -type f -name "LocalSettings.php"

Открыв его редактором “vim”, выяснили, что файл пустой. Поскольку в домашней директории находился файл с необходимыми конфигурациями, мы переместились туда с помощью команды cd. При попытке открыть файл обнаружили отсутствие свободного места на диске. Для проверки объёма использовали команду: df -h

Файловая система Размер Использовано  Дост Использовано% Cмонтировано в
devtmpfs           	1,9G            0 			1,9G            0%	/dev
tmpfs              	1,9G            0  		1,9G            0%	/dev/shm
tmpfs              	1,9G          65M  		1,9G            4%	/run
tmpfs              	1,9G            0  		1,9G            0% 	/sys/fs/cgroup
/dev/nvme0n1p1      	10G          10G  		 20K          100%			 /tmpfs              	389M            0  		389M            0%	/run/user/1000

Вывели список файлов, занимающих более 1 ГБ, с помощью команды:

sudo find / -type f -size +1G

Следующей командой мы определили размер данного файла. Из предыдущей команды мы узнали, что такой файл только один, и получили полный путь к нему:

sudo du -h /var/log/httpd/access_log

Этим файлом оказался лог, занимающий 7 ГБ. Поскольку перед нами стояла задача восстановить работоспособность сервера, мы решили очистить его с помощью команды:

sudo truncate -s 0 /var/log/httpd/access_log 

После очистки файла мы проверили, что он пустой. Затем вернулись к файлу LocalSettings\(5\).php, который находился в домашней директории, и обнаружили, что это конфигурационный файл. С помощью команды cp мы переместили его в нужную директорию и переименовали в LocalSettings.php. Также в этом файле мы изменили адрес сервера на корректный. После этих изменений сервер удалось запустить.
Чтобы в дальнейшем избежать подобной проблемы, мы написали скрипт log_backup.sh для архивирования логов.
#!/bin/bash
# Параметры
LOG_DIR="/var/log/httpd" # Путь к каталогу с логами
ARCHIVE_DIR="/var/log/httpd/archive" # Путь для хранения архивов
DAYS_TO_KEEP=1 # Количество дней для хранения архивов
# Создание каталога для архивов, если его еще нет
mkdir -p "$ARCHIVE_DIR"
# Текущая дата для имени архива
DATE=$(date +"%Y-%m-%d")


# Архивируем все файлы логов в указанной директории
find "$LOG_DIR" -type f -name "*.log" -exec tar -rvf "$ARCHIVE_DIR/logs-$DATE.tar" {} \;
# Сжимаем созданный архив
gzip "$ARCHIVE_DIR/logs-$DATE.tar"
# Очищаем все файлы логов
find "$LOG_DIR" -type f -name "*.log" -exec truncate -s 0 {} \;
# Удаляем архивы старше одного дня
find "$ARCHIVE_DIR" -type f -name "*.tar.gz" -mtime +$DAYS_TO_KEEP -exec rm -f {} \;
# Сообщение о завершении
echo "Архивирование логов завершено. Логи очищены. Старые архивы удалены."

 Предоставив скрипту задачу на автозапуск, обнаружили, что уже существует задание, согласно которому файл архивируется каждую минуту:


* * * * * tar -czf /var/log/httpd/log_$(date +\%Y\%m\%d).tar.gz -C /var/log/httpd .

Мы закомментировали эту задачу и создали инженерное задание для нашего скрипта, согласно которому он будет запускаться ежедневно в 00:00. Указали полный путь для его выполнения:

0 0 * * * /home/ec2-user/log_backup.sh.


Следующей командой предоставили права на выполнение этого скрипта:


chmod +x log_backup.sh.


Формулирование рекомендаций и предложений по улучшению процессов
 Мониторинг дискового пространства
Настроить автоматическое уведомление о заполнении диска свыше 80%.
 Проверка критически важных файлов
Регулярно проверять целостность и содержимое конфигурационных файлов.
 Резервное копирование логов
Использовать централизованное хранилище для логов, чтобы избежать их накопления на сервере.
Автоматизация задач
Автоматизировать задачи по очистке и архивированию логов с использованием надежного расписания.
Документация процедур
Обновить документацию с подробным описанием шагов по устранению подобных инцидентов, включая команды и скрипты.
Тестирование скриптов
Регулярно тестировать новые скрипты и настройки на тестовом окружении перед внедрением в рабочее.




















